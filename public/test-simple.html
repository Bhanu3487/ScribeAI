<!DOCTYPE html>
<html>

<head>
  <title>Simple Audio Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
    }

    button {
      padding: 15px 30px;
      font-size: 18px;
      margin: 10px 0;
      cursor: pointer;
      border: none;
      border-radius: 5px;
    }

    #record {
      background-color: #4CAF50;
      color: white;
    }

    #record:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }

    #record.recording {
      background-color: #f44336;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.7;
      }
    }

    #status {
      margin: 20px 0;
      padding: 15px;
      background-color: #f0f0f0;
      border-radius: 5px;
      min-height: 50px;
    }

    audio {
      width: 100%;
      margin-top: 20px;
    }

    .timer {
      font-size: 24px;
      font-weight: bold;
      color: #f44336;
      margin: 10px 0;
    }
  </style>
</head>

<body>
  <h1>üéôÔ∏è 5-Second Audio Test</h1>
  <button id="record">üî¥ Start Recording</button>
  <div class="timer" id="timer"></div>
  <div id="status">Ready - Click button to start</div>
  <!-- playback removed: recordings are not shown or played back in the UI -->

  <script>
    let mediaRecorder;
    let audioChunks = [];
    let sessionId;
    let userId;
    let countdown;

    const recordBtn = document.getElementById('record');
    const statusDiv = document.getElementById('status');
    const timerDiv = document.getElementById('timer');
    // playback element removed ‚Äî we don't display or play recorded audio

    recordBtn.onclick = async () => {
      try {
        recordBtn.disabled = true;
        statusDiv.textContent = 'Setting up...';

        // 1. Create/get user first
        const userRes = await fetch('http://localhost:3000/api/auth/mock-login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: 'test@scribeai.com' })
        });

        if (!userRes.ok) {
          throw new Error('Failed to create user');
        }

        const userData = await userRes.json();
        userId = userData.userId;
        console.log('User ID:', userId);

        // 2. Create session
        const sessionRes = await fetch('http://localhost:3000/api/session/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId })
        });

        if (!sessionRes.ok) {
          throw new Error('Failed to start session');
        }

        const sessionData = await sessionRes.json();
        sessionId = sessionData.sessionId;
        console.log('Session ID:', sessionId);

        // 3. Get microphone access
        statusDiv.textContent = 'Requesting microphone access...';
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

        // 4. Setup recorder
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = (event) => {
          audioChunks.push(event.data);
        };

        mediaRecorder.onstop = async () => {
          // Stop visual indicators
          recordBtn.classList.remove('recording');
          recordBtn.textContent = 'üî¥ Start Recording';
          timerDiv.textContent = '';

          // Create audio blob
          const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });

          // Recording saved but not displayed or played back (UI intentionally silent)

          // Upload and transcribe
          statusDiv.innerHTML = '‚è≥ Uploading and transcribing...';

          const formData = new FormData();
          formData.append('audio', audioBlob, 'recording.wav');
          formData.append('sessionId', sessionId);

          try {
            const uploadRes = await fetch('http://localhost:3000/api/transcribe', {
              method: 'POST',
              body: formData
            });

            if (!uploadRes.ok) {
              throw new Error('Upload failed');
            }

            const result = await uploadRes.json();

            statusDiv.innerHTML = `
              <strong>‚úÖ Transcription:</strong><br>
              <div style="font-size: 16px; margin-top: 10px; padding: 10px; background: white; border-left: 4px solid #4CAF50;">
                ${result.transcription}
              </div>
            `;

            // Get summary
            const summaryRes = await fetch('http://localhost:3000/api/session/summary', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ sessionId })
            });

            if (summaryRes.ok) {
              const summaryData = await summaryRes.json();
              statusDiv.innerHTML += `
                <br><strong>üìù AI Summary:</strong><br>
                <div style="font-size: 14px; margin-top: 10px; padding: 10px; background: white; border-left: 4px solid #2196F3;">
                  ${summaryData.summary}
                </div>
              `;
            }

            recordBtn.disabled = false;
          } catch (error) {
            statusDiv.innerHTML = `<strong>‚ùå Error:</strong> ${error.message}`;
            recordBtn.disabled = false;
          }
        };

        // 5. Start recording
        mediaRecorder.start();
        recordBtn.classList.add('recording');
        recordBtn.textContent = '‚è∫Ô∏è Recording...';
        statusDiv.textContent = 'üéôÔ∏è Recording in progress - Speak clearly!';

        // Countdown timer
        let secondsLeft = 5;
        timerDiv.textContent = `${secondsLeft}s`;

        countdown = setInterval(() => {
          secondsLeft--;
          timerDiv.textContent = `${secondsLeft}s`;

          if (secondsLeft <= 0) {
            clearInterval(countdown);
            timerDiv.textContent = '';
          }
        }, 1000);

        // 6. Auto-stop after 5 seconds
        setTimeout(() => {
          if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
            stream.getTracks().forEach(track => track.stop());
          }
        }, 5000);

      } catch (error) {
        console.error('Error:', error);
        statusDiv.innerHTML = `<strong>‚ùå Error:</strong> ${error.message}`;
        recordBtn.disabled = false;
        recordBtn.classList.remove('recording');
        timerDiv.textContent = '';
      }
    };
  </script>
</body>

</html>